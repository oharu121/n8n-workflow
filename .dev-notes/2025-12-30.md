# n8n on Hugging Face Spaces - Implementation Plan

## Overview
Deploy n8n workflow automation to Hugging Face Spaces with GitHub CI/CD, Supabase PostgreSQL persistence, and a wake-up endpoint for Google Apps Script.

## Configuration
- **Timezone**: Asia/Tokyo (JST)
- **Authentication**: Basic auth (username/password required)
- **Space Name**: `n8n-workflow` → URL: `https://oharu121-n8n-workflow.hf.space`

---

## File Structure (New Files to Create)

```
f:\repository\n8n-workflow\
├── Dockerfile                              # NEW - HF Spaces Docker config
├── README.md                               # MODIFY - Add HF Spaces YAML frontmatter
├── .gitignore                              # NEW - Ignore sensitive files
├── .github/
│   └── workflows/
│       └── deploy-to-hf-spaces.yml         # NEW - CI/CD workflow
├── scripts/
│   ├── startup.sh                          # NEW - Container startup script
│   └── db-keepalive.sh                     # NEW - Supabase keep-alive
├── workflows/                              # NEW - n8n workflow templates
│   └── wake-up-endpoint.json               # NEW - Optional custom wake-up webhook
└── pick-news-and-send-mail/                # EXISTING - Keep as-is
    ├── workflow.json
    ├── README.md
    └── diagram.png
```

---

## Implementation Steps

### Step 1: Create Dockerfile
**File**: `f:\repository\n8n-workflow\Dockerfile`

Key specifications:
- Base: `node:24-alpine`
- Port: `7860` (required by HF Spaces)
- Dependencies: chromium, ffmpeg, yt-dlp, postgresql-client
- n8n version: latest stable
- Timezone: `Asia/Tokyo`
- Health endpoints enabled (`QUEUE_HEALTH_CHECK_ACTIVE=true`, `N8N_METRICS=true`)
- Basic auth enabled via env vars

### Step 2: Create README.md with HF Spaces Frontmatter
**File**: `f:\repository\n8n-workflow\README.md`

YAML frontmatter required:
```yaml
---
title: n8n Workflow Automation
emoji: ⚡
colorFrom: orange
colorTo: red
sdk: docker
app_port: 7860
pinned: false
---
```

### Step 3: Create Startup Script
**File**: `f:\repository\n8n-workflow\scripts\startup.sh`

Responsibilities:
- Wait for Supabase database to be ready
- Start db-keepalive background process
- Launch n8n

### Step 4: Create Database Keep-Alive Script
**File**: `f:\repository\n8n-workflow\scripts\db-keepalive.sh`

- Runs `SELECT 1` every 5 minutes
- Prevents Supabase connection from going stale

### Step 5: Create GitHub Actions Workflow
**File**: `f:\repository\n8n-workflow\.github\workflows\deploy-to-hf-spaces.yml`

Triggers:
- Push to `main` branch
- Manual dispatch

Actions:
- Push code to HF Spaces git remote
- Health check after deployment

### Step 6: Create .gitignore
**File**: `f:\repository\n8n-workflow\.gitignore`

Ignore: `.env`, `*.local`, `node_modules/`, etc.

### Step 7: Create Wake-Up Workflow (Optional)
**File**: `f:\repository\n8n-workflow\workflows\wake-up-endpoint.json`

Simple webhook that returns JSON status - alternative to built-in `/healthz`

---

## Environment Variables

### Set in Dockerfile (defaults)
| Variable | Value |
|----------|-------|
| `N8N_PORT` | `7860` |
| `N8N_PROTOCOL` | `https` |
| `N8N_HOST` | `0.0.0.0` |
| `GENERIC_TIMEZONE` | `Asia/Tokyo` |
| `TZ` | `Asia/Tokyo` |
| `N8N_SECURE_COOKIE` | `false` |
| `QUEUE_HEALTH_CHECK_ACTIVE` | `true` |
| `N8N_METRICS` | `true` |

### Set in HF Spaces Secrets (user must configure)
| Variable | Description |
|----------|-------------|
| `N8N_ENCRYPTION_KEY` | Generate with `openssl rand -hex 32` |
| `N8N_BASIC_AUTH_ACTIVE` | `true` |
| `N8N_BASIC_AUTH_USER` | Your username |
| `N8N_BASIC_AUTH_PASSWORD` | Your password |
| `WEBHOOK_URL` | `https://oharu121-n8n-workflow.hf.space` |
| `N8N_EDITOR_BASE_URL` | `https://oharu121-n8n-workflow.hf.space` |
| `DB_TYPE` | `postgresdb` |
| `DB_POSTGRESDB_HOST` | Supabase host |
| `DB_POSTGRESDB_PORT` | `6543` (transaction pooler) |
| `DB_POSTGRESDB_DATABASE` | `postgres` |
| `DB_POSTGRESDB_USER` | `postgres` |
| `DB_POSTGRESDB_PASSWORD` | Supabase password |
| `DB_POSTGRESDB_SSL_ENABLED` | `true` |

### Set in GitHub Secrets (for CI/CD)
| Secret | Description |
|--------|-------------|
| `HF_TOKEN` | Hugging Face API token (write access) |
| `HF_USERNAME` | `oharu121` |
| `HF_SPACE_NAME` | `n8n-workflow` |

---

## Wake-Up Strategy

### For Google Apps Script
Use the built-in health endpoint:
```
GET https://oharu121-n8n-workflow.hf.space/healthz
```

Google Apps Script example:
```javascript
function wakeUpN8n() {
  const url = 'https://oharu121-n8n-workflow.hf.space/healthz';
  const response = UrlFetchApp.fetch(url, { muteHttpExceptions: true });
  Logger.log('Status: ' + response.getResponseCode());
}

// Set trigger to run every 40 hours (before 48h sleep threshold)
```

---

## Supabase Keep-Alive Strategy

1. **Background script** - `db-keepalive.sh` runs `SELECT 1` every 5 minutes
2. **Transaction pooler** - Use port 6543 instead of 5432 for better connection management
3. **n8n workflows** - Scheduled workflows themselves keep connections active

---

## Post-Deployment Checklist

1. [ ] Create HF Space at huggingface.co/new-space (Docker SDK, select persistent storage)
2. [ ] Add all secrets in HF Space Settings > Variables and Secrets
3. [ ] Add GitHub secrets for CI/CD
4. [ ] Push to main to trigger deployment
5. [ ] Verify `/healthz` returns 200
6. [ ] Verify `/healthz/readiness` returns 200 (DB connected)
7. [ ] Log in with basic auth credentials
8. [ ] Import existing workflow from `pick-news-and-send-mail/workflow.json`
9. [ ] Set up Google Apps Script wake-up trigger
10. [ ] Test scheduled workflow execution

---

## Key Design Decisions

1. **Dockerfile at root** - Required by HF Spaces
2. **Port 7860** - Mandatory for HF Spaces
3. **No N8N_SECURE_COOKIE** - HF Spaces handles SSL termination
4. **Transaction pooler (6543)** - Better for ephemeral environments
5. **Built-in /healthz** - Simpler than custom webhook for wake-up
6. **tini as init** - Proper signal handling for container shutdown

---

## Sources
- [HF Spaces Docker SDK](https://huggingface.co/docs/hub/en/spaces-sdks-docker)
- [n8n Environment Variables](https://docs.n8n.io/hosting/configuration/environment-variables/)
- [n8n Monitoring](https://docs.n8n.io/hosting/logging-monitoring/monitoring/)
- [Supabase Connection Management](https://supabase.com/docs/guides/database/connection-management)
